<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">

<head>
    <meta charset="utf-8">
    <title>账本</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <!--标准mui.css-->
    <link rel="stylesheet" href="./css/mui.min.css">
    <!--App自定义的css-->
    <!--<link rel="stylesheet" type="text/css" href="../css/app.css"/>-->

</head>
<style>
    * { touch-action: pan-y; }
    .rd { color:red; }
    .gr { color:green;}
    .mui-pull-bottom-pocket {
        height:0px ;
    }
</style>
<body>
<header class="mui-bar mui-bar-nav">
    <h1 class="mui-title">账本信息 | 总资产<span id="total"></span></h1>
</header>
<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
<div class="mui-content">

</div>
</div>
<!------------------------------------------>
<nav class="mui-bar mui-bar-tab">
    <a class="mui-tab-item" href="./add.html">
        <span class="mui-icon mui-icon-plus"></span>
        <span class="mui-tab-label">记账</span>
    </a>

    <a class="mui-tab-item"  href="./setting.html">
        <span class="mui-icon mui-icon-gear"></span>
        <span class="mui-tab-label">设置</span>
    </a>
</nav>

<script src="./js/mui.min.js"></script>
<script src="./js/common.js"></script>
<script src="./js/jQuery.min.js"></script>
<script>
    var count = 0;
    function pullupRefresh() {
        setTimeout(function() {
            mui('#pullrefresh').pullRefresh().endPullupToRefresh((++count > 2)); //参数为true代表没有更多数据了。

        }, 1500);
    }
    function pulldownRefresh() {
        setTimeout(function() {
            mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
            freshtotal();
            mui.toast("已更新~！");
        }, 1000);
    }
    //刷新总金额
    function freshtotal(){
        var totalmoney = 0;

        $.ajax({
            url:'./rest/list',
            type:'POST',
            beforeSend:function(){
                // $(".mui-content").html("")
            },
            success:function(result){
                var accounts=JSON.parse(result);
                for(var i=0;i<accounts.length;i++){
                    var accname = accounts[i].accname; //账户中文名
                    var account = accounts[i].account; //账户账号
                    var balance = accounts[i].balance; //余额
                    var prop = accounts[i].prop;       //账户类型
                    if(prop==1){
                        totalmoney+=balance*100;
                    }else{
                        totalmoney-=balance*100;
                    }
                }

                //设置总金额
                var finalmoney = totalmoney/100;
                $("#total").text(number_format(finalmoney,2,".",","));//格式化成两位小数
                if(finalmoney<0){
                    $("#total").addClass("rd");
                }else{
                    $("#total").addClass("gr");
                }

            },
            error:function(){
                mui.toast("网络错误");
            }
        })
    }
    function adddelbtn(){
        var btnArray = ['确认', '取消'];
        //第二个demo，向左拖拽后显示操作图标，释放后自动触发的业务逻辑
        $('.mui-table-view-cell').on('slideleft', '.mui-table-view-cell', function(event) {
            var elem = this;
            mui.confirm('确认删除该条记录？', '删除', btnArray, function(e) {

                if (e.index === 0) {
                    $.ajax({
                        url:'./rest/deldetail',
                        type:'POST',
                        data:{"id":elem.value},
                        dataType:'json',
                        success:function(result){
                            if(result&&result.code==='0'){
                                elem.parentNode.removeChild(elem);
                                freshtotal();
                                mui.toast("已删除!");
                            }else{
                                mui.toast("删除失败！");
                            }
                        },
                        error:function(){
                            mui.toast("网络错误");
                        }

                    })

                } else {
                    setTimeout(function() {
                        mui.swipeoutClose(elem);
                    }, 0);
                }
            });
        });
    }
    function freshData(){
        var totalmoney = 0;

        $.ajax({
            url:'./rest/list',
            type:'POST',
            beforeSend:function(){
            },
            success:function(result){
                var accounts=JSON.parse(result);
                for(var i=0;i<accounts.length;i++){
                    var accname = accounts[i].accname; //账户中文名
                    var account = accounts[i].account; //账户账号
                    var balance = accounts[i].balance; //余额
                    var prop = accounts[i].prop;       //账户类型
                    if(prop==1){
                        totalmoney+=balance*100;
                    }else{
                        totalmoney-=balance*100;
                    }
                        //设置***
                        if(account.length>7){
                            var startacc=account.substr(0,3);
                            var midacc="***";
                            var endacc=account.substr(account.length-4);
                            account="".concat(startacc).concat(midacc).concat(endacc);
                        }

                        var strdetail ='';
                        var deitem = accounts[i].beanWaterList;
                        //拼接详情信息
                        for(var j =0;j<deitem.length;j++){
                            if(deitem[j].trtype){

                                var color = '';
                                var zhengfu = '';
                                if(prop=="1"){
                                    color= deitem[j].trtype==0?"red":"green";
                                    zhengfu =deitem[j].trtype==0?"-":"+";
                                }else{
                                    color=  deitem[j].trtype==1?"red":"green";
                                    zhengfu = deitem[j].trtype==1?"-":"+";
                                }

                                strdetail+='<li class="mui-table-view-cell" value="'+deitem[j].wid+'">'+
                                    '<div class="mui-slider-right mui-disabled">'+
                                    '<a class="mui-btn mui-btn-red">删除</a>'+
                                    '</div>'+
                                    '<div class="mui-slider-handle mui-table">' +
                                    '<div style="float:left;width:30%;"><label>'+new Date(deitem[j].updatetime).Format('yyyy-MM-dd')+'</label>:</div>'+
                                    '<div style="float:left;"><label><span>'+(deitem[j].remark==undefined?"":deitem[j].remark)+'</span></label></div>'+
                                    '<div style="float:right;"><span class="mui-text-right" style="color:'+color+';">'+zhengfu+'  '+number_format(deitem[j].trnum,2,".",",")+'</span></div>'+
                                    '</div>'+
                                    '</li>'
                            }
                        }

                        //拼接基本信息
                        var cardhtml =
                            '<div class="mui-card" style="margin: 15px 0px;">'+
                            '<ul class="mui-table-view mui-table-view-chevron">'+
                            '<li class="mui-table-view-cell mui-collapse">'+
                            '<a class="mui-navigate-right" href="#"> '+(prop==1?"(资产)":"(负债)")+' '+accname+' | '+account+'  <span style="float: right"> 余额:'+number_format(balance,2,".",",")+'</span></a>'+
                            '<ul class="mui-table-view mui-table-view-chevron">'+strdetail+
                            '</ul>'+
                            '</div>';
                        $(".mui-content").append(cardhtml);
                    }
                adddelbtn();

                //设置总金额
                var finalmoney = totalmoney/100;
                $("#total").text(number_format(finalmoney,2,".",","));//格式化成两位小数
                if(finalmoney<0){
                    $("#total").addClass("rd");
                }else{
                    $("#total").addClass("gr");
                }

            },
            error:function(){
                mui.toast("网络错误");
            }
        })
    }
    $(function(){
        mui.init({
            pullRefresh: {
                container: '#pullrefresh',
                down: {
                    style:'circle',
                    callback: pulldownRefresh
                },
                up: {
                    auto:true,
                    contentrefresh: '正在加载...',
                    callback: pullupRefresh
                }
            }
        });
        freshData();
    })
</script>
</body>

</html>